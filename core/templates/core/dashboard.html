{% extends 'core/base.html' %}

{% load static %}

{% block title %}Registro de Cliente{% endblock %}

{% block content %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Dashboard - Óptica</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    .kpi-card { border-radius: 14px; }
    .kpi-title { font-size: .85rem; opacity: .75; }
    .kpi-value { font-size: 1.35rem; font-weight: 700; }
    .table-sm td, .table-sm th { padding: .35rem .45rem; }
    .chart-box { height: 280px; }
  </style>
</head>

<body class="bg-light">
  <div class="container-fluid py-3">

    <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between mb-3">
      <div>
        <h3 class="mb-0">Dashboard</h3>
        <small class="text-muted" id="rangeLabel">Rango: -</small>
      </div>

      <div class="d-flex gap-2">
        <select id="preset" class="form-select">
          <option value="today">Hoy</option>
          <option value="week">Semana</option>
          <option value="month" selected>Mes</option>
        </select>
        <button class="btn btn-dark" id="btnRefresh">Actualizar</button>
      </div>
    </div>

    <!-- KPIs -->
    <div class="row g-3 mb-3">
      <div class="col-12 col-md-3">
        <div class="card kpi-card shadow-sm">
          <div class="card-body">
            <div class="kpi-title">Ventas (Hoy)</div>
            <div class="kpi-value" id="kpiVentasHoy">S/ 0.00</div>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-3">
        <div class="card kpi-card shadow-sm">
          <div class="card-body">
            <div class="kpi-title">Tickets (Hoy)</div>
            <div class="kpi-value" id="kpiTicketsHoy">0</div>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-3">
        <div class="card kpi-card shadow-sm">
          <div class="card-body">
            <div class="kpi-title">Saldo pendiente (Hoy)</div>
            <div class="kpi-value" id="kpiSaldoHoy">S/ 0.00</div>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-3">
        <div class="card kpi-card shadow-sm">
          <div class="card-body">
            <div class="kpi-title">Ventas (Mes)</div>
            <div class="kpi-value" id="kpiVentasMes">S/ 0.00</div>
            <div class="small text-muted">Ticket prom: <span id="kpiTicketProm">S/ 0.00</span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Cobros por medio (hoy) -->
    <div class="row g-3 mb-3">
      <div class="col-12">
        <div class="card shadow-sm">
          <div class="card-body d-flex flex-wrap gap-3 align-items-center">
            <div class="fw-bold">Cobros (Hoy):</div>
            <div>Efectivo: <span class="fw-bold" id="cobroEF">S/ 0.00</span></div>
            <div>Yape: <span class="fw-bold" id="cobroYAPE">S/ 0.00</span></div>
            <div>Plin: <span class="fw-bold" id="cobroPLIN">S/ 0.00</span></div>
            <div>Tarjeta: <span class="fw-bold" id="cobroTARJETA">S/ 0.00</span></div>
            <div>Transferencia: <span class="fw-bold" id="cobroTRANSFERENCIA">S/ 0.00</span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts: Ventas -->
    <div class="row g-3 mb-3">
      <div class="col-12 col-lg-7">
        <div class="card shadow-sm">
          <div class="card-header bg-white fw-bold">Ventas por día</div>
          <div class="card-body">
            <div class="chart-box">
              <canvas id="chartVentasDia"></canvas>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 col-lg-5">
        <div class="card shadow-sm">
          <div class="card-header bg-white fw-bold">Ventas por categoría</div>
          <div class="card-body">
            <div class="chart-box">
              <canvas id="chartVentasCat"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Lunas -->
    <div class="row g-3 mb-3">
      <div class="col-12">
        <div class="card shadow-sm">
          <div class="card-header bg-white fw-bold">Lunas (Distribución)</div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-12 col-lg-4">
                <div class="chart-box"><canvas id="chartLunasEnfoque"></canvas></div>
              </div>
              <div class="col-12 col-lg-4">
                <div class="chart-box"><canvas id="chartLunasMaterial"></canvas></div>
              </div>
              <div class="col-12 col-lg-4">
                <div class="chart-box"><canvas id="chartLunasTrat"></canvas></div>
              </div>
            </div>
            <small class="text-muted" id="lunasNota"></small>
          </div>
        </div>
      </div>
    </div>

    <!-- Taller / Biselado + SLA LISTO -->
    <div class="row g-3 mb-3">
      <div class="col-12 col-lg-7">
        <div class="card shadow-sm">
          <div class="card-header bg-white fw-bold">Taller - Biselado</div>
          <div class="card-body">
            <div class="d-flex flex-wrap gap-4 mb-2">
              <div>Promedio: <span class="fw-bold" id="biselAvg">0</span> min</div>
              <div>Mediana: <span class="fw-bold" id="biselMed">0</span> min</div>
            </div>
            <div class="chart-box mb-3">
              <canvas id="chartBiseladoSerie"></canvas>
            </div>

            <div class="row g-3">
              <div class="col-12 col-lg-6">
                <div class="fw-bold mb-1">En biselado (ahora)</div>
                <div class="table-responsive">
                  <table class="table table-sm table-striped">
                    <thead><tr><th>Ticket</th><th>Cliente</th><th>Inicio</th><th>Min</th></tr></thead>
                    <tbody id="tblEnBiselado"></tbody>
                  </table>
                </div>
              </div>
              <div class="col-12 col-lg-6">
                <div class="fw-bold mb-1">Top 5 más lentas</div>
                <div class="table-responsive">
                  <table class="table table-sm table-striped">
                    <thead><tr><th>Ticket</th><th>Cliente</th><th>Min</th></tr></thead>
                    <tbody id="tblBiselTop"></tbody>
                  </table>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>

      <div class="col-12 col-lg-5">
        <div class="card shadow-sm">
          <div class="card-header bg-white fw-bold">Entregas a destiempo (contra LISTO)</div>
          <div class="card-body">
            <div class="d-flex flex-wrap gap-4 mb-2">
              <div>A tiempo: <span class="fw-bold" id="slaATiempo">0</span></div>
              <div>Tarde: <span class="fw-bold" id="slaTarde">0</span></div>
              <div>Retraso prom: <span class="fw-bold" id="slaProm">0</span> min</div>
            </div>

            <div class="chart-box mb-3">
              <canvas id="chartSLA"></canvas>
            </div>

            <div class="fw-bold mb-1">Top tardíos</div>
            <div class="table-responsive">
              <table class="table table-sm table-striped">
                <thead><tr><th>Ticket</th><th>Cliente</th><th>Min tarde</th></tr></thead>
                <tbody id="tblSLATop"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Inventario + Caja -->
    <div class="row g-3 mb-3">
      <div class="col-12 col-lg-6">
        <div class="card shadow-sm">
          <div class="card-header bg-white fw-bold">Inventario</div>
          <div class="card-body">
            <div class="fw-bold mb-1">Stock crítico</div>
            <div class="table-responsive mb-3">
              <table class="table table-sm table-striped">
                <thead><tr><th>Cód</th><th>Producto</th><th>Stock</th></tr></thead>
                <tbody id="tblStockCrit"></tbody>
              </table>
            </div>

            <div class="fw-bold mb-1">Top vendidos</div>
            <div class="table-responsive">
              <table class="table table-sm table-striped">
                <thead><tr><th>Cód</th><th>Producto</th><th>Cant</th></tr></thead>
                <tbody id="tblTopVendidos"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-6">
        <div class="card shadow-sm">
          <div class="card-header bg-white fw-bold">Caja (ingresos vs egresos)</div>
          <div class="card-body">
            <div class="mb-2">Gastos (rango): <span class="fw-bold" id="gastosRango">S/ 0.00</span></div>
            <div class="chart-box">
              <canvas id="chartCaja"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Cobranzas -->
    <div class="row g-3">
      <div class="col-12">
        <div class="card shadow-sm">
          <div class="card-header bg-white fw-bold">Cobranzas (Top deudores)</div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-sm table-striped">
                <thead><tr><th>Cliente</th><th>Teléfono</th><th>Saldo</th></tr></thead>
                <tbody id="tblDeudores"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script src="{% static 'core/js/dashboard.js' %}"></script>
</body>
</html>


{% endblock %}

