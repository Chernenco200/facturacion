{% extends "core/base.html" %}
{% block title %}Panel Operador{% endblock %}

{% block content %}
<div class="container-fluid py-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">Panel Operador - Órdenes</h3>

    <form method="get" class="d-flex gap-2" style="max-width: 420px;">
      <input type="text" name="q" class="form-control" placeholder="Buscar: N° ticket o cliente" value="{{ q }}">
      <button class="btn btn-outline-primary" type="submit">Buscar</button>
      <a class="btn btn-outline-secondary" href="{% url 'operador_ordenes' %}">Limpiar</a>
    </form>
  </div>

  <div class="table-responsive">
    <table class="table table-bordered table-hover align-middle">
      <thead class="table-dark">
        <tr>
          <th style="width:90px;">Ticket</th>
          <th style="width:170px;">Cliente</th>
          <th style="width:190px;">Entrega</th>
          <th style="width:140px;" class="text-center">SLA</th>
          <th style="width:200px;">Estado actual</th>
          <th>Acciones</th>
        </tr>
      </thead>

      <tbody>
        {% for ot in ordenes %}
        {% with mins=ot.minutos_retraso %}
        <tr
          {% if mins == 0 %}
            class="table-success"
          {% elif mins <= 10 %}
            class="table-warning"
          {% else %}
            class="table-danger"
          {% endif %}
        >
          <td class="fw-bold">#{{ ot.ticket.numero }}</td>

          <td>
            {# Cliente público: inicial + apellido #}
            {% if ot.ticket.cliente and ot.ticket.cliente.nombre %}
              {% with parts=ot.ticket.cliente.nombre.split %}
                <span class="fw-bold">
                  {{ parts.0|slice:":1"|upper }}.
                  {% if parts|length > 1 %}
                    {{ parts|last|upper }}
                  {% endif %}
                </span>
              {% endwith %}
            {% else %}
              <span class="text-muted">CLIENTE</span>
            {% endif %}
          </td>

          <td>
            {% if ot.due_datetime %}
              {{ ot.due_datetime|date:"d/m/Y H:i" }}
            {% else %}
              <span class="text-muted">Sin hora</span>
            {% endif %}
          </td>

          <td class="text-center fw-bold">
            {% if mins == 0 %}
              A tiempo ✅
            {% else %}
              +{{ mins }} min ⏱
            {% endif %}
          </td>

          <td class="fw-bold">{{ ot.estado_publico }}</td>

          <td>
            <div class="d-flex flex-wrap gap-2">

              <!-- Botones de flujo (grandes) -->
              <form method="post" action="{% url 'operador_cambiar_estado' ot.ticket.id %}">
                {% csrf_token %}
                <input type="hidden" name="estado" value="LAB_PEDIDO">
                <button class="btn btn-sm btn-outline-dark">Lab pedido</button>
              </form>

              <form method="post" action="{% url 'operador_cambiar_estado' ot.ticket.id %}">
                {% csrf_token %}
                <input type="hidden" name="estado" value="BISELADO">
                <button class="btn btn-sm btn-outline-primary">Biselado</button>
              </form>

              <form method="post" action="{% url 'operador_cambiar_estado' ot.ticket.id %}">
                {% csrf_token %}
                <input type="hidden" name="estado" value="UV">
                <button class="btn btn-sm btn-outline-warning">UV</button>
              </form>

              <form method="post" action="{% url 'operador_cambiar_estado' ot.ticket.id %}">
                {% csrf_token %}
                <input type="hidden" name="estado" value="LISTO">
                <button class="btn btn-sm btn-success">Listo</button>
              </form>

              <form method="post" action="{% url 'operador_cambiar_estado' ot.ticket.id %}">
                {% csrf_token %}
                <input type="hidden" name="estado" value="ENTREGADO">
                <button class="btn btn-sm btn-danger">Entregado</button>
              </form>

            </div>

            <div class="mt-2 small text-muted">
              Últ. actualización: {{ ot.fecha_hora_ultima_actualizacion|date:"d/m H:i" }}
            </div>
          </td>
        </tr>
        {% endwith %}
        {% empty %}
        <tr>
          <td colspan="6" class="text-center">No hay órdenes activas.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="mt-3 small text-muted">
    Semáforo SLA:
    <span class="badge bg-success">A tiempo</span>
    <span class="badge bg-warning text-dark">1–10 min tarde</span>
    <span class="badge bg-danger">11+ min tarde</span>
  </div>

</div>
{% endblock %}
