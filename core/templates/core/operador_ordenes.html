{% extends "core/base.html" %}
{% block title %}Panel Operador{% endblock %}

{% block content %}
<style>
  /* ====== MOBILE CARDS (solo < md) ====== */
  @media (max-width: 767.98px) {
    .ot-table thead { display: none; } /* ocultamos encabezado */
    .ot-table, .ot-table tbody, .ot-table tr, .ot-table td { display: block; width: 100%; }

    .ot-table tr {
      border: 1px solid rgba(0,0,0,.15);
      border-radius: .75rem;
      margin-bottom: .75rem;
      overflow: hidden;
    }

    .ot-table td {
      border: 0 !important;
      padding: .6rem .8rem;
    }

    /* etiqueta + valor en cada "fila" */
    .ot-table td[data-label] {
      display: flex;
      gap: .75rem;
      justify-content: space-between;
      align-items: baseline;
    }
    .ot-table td[data-label]::before {
      content: attr(data-label);
      font-weight: 700;
      color: rgba(0,0,0,.65);
      flex: 0 0 auto;
    }
    .ot-table td[data-label] > * {
      text-align: right;
    }

    /* acciones: botones a 2 columnas en móvil */
    .ot-actions {
      display: grid !important;
      grid-template-columns: 1fr 1fr;
      gap: .5rem;
    }
    .ot-actions form button {
      width: 100%;
    }

    /* SLA centrado sin "columna" */
    .ot-sla {
      justify-content: space-between;
    }
  }
</style>

<div class="container-fluid py-3">
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2 mb-3">
    <h3 class="mb-0">Panel Operador - Órdenes</h3>

    <form method="get" class="d-flex flex-column flex-sm-row gap-2 w-100 w-md-auto" style="max-width: 520px;">
      <input type="text" name="q" class="form-control" placeholder="Buscar: N° ticket o cliente" value="{{ q }}">
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary w-100" type="submit">Buscar</button>
        <a class="btn btn-outline-secondary w-100" href="{% url 'operador_ordenes' %}">Limpiar</a>
      </div>
    </form>
  </div>

  <div class="table-responsive">
    <table class="table table-bordered table-hover align-middle ot-table">
      <thead class="table-dark">
        <tr>
          <th style="width:90px;">Ticket</th>
          <th style="width:170px;">Cliente</th>
          <th style="width:190px;">Entrega</th>
          <th style="width:140px;" class="text-center">SLA</th>
          <th style="width:200px;">Estado actual</th>
          <th>Acciones</th>
        </tr>
      </thead>

      <tbody>
        {% for ot in ordenes %}
        {% with mins=ot.minutos_retraso %}
        <tr
          {% if mins == 0 %}
            class="table-success"
          {% elif mins <= 10 %}
            class="table-warning"
          {% else %}
            class="table-danger"
          {% endif %}
        >
          <td class="fw-bold" data-label="Ticket">#{{ ot.ticket.numero }}</td>

          <td data-label="Cliente">
            {% if ot.ticket.cliente and ot.ticket.cliente.nombre %}
              {% with parts=ot.ticket.cliente.nombre.split %}
                <span class="fw-bold">
                  {{ parts.0|slice:":1"|upper }}.
                  {% if parts|length > 1 %}
                    {{ parts|last|upper }}
                  {% endif %}
                </span>
              {% endwith %}
            {% else %}
              <span class="text-muted">CLIENTE</span>
            {% endif %}
          </td>

          <td data-label="Entrega">
            {% if ot.due_datetime %}
              {{ ot.due_datetime|date:"d/m/Y H:i" }}
            {% else %}
              <span class="text-muted">Sin hora</span>
            {% endif %}
          </td>

          <td class="text-center fw-bold ot-sla" data-label="SLA">
            {% if mins == 0 %}
              <span>A tiempo ✅</span>
            {% else %}
              <span>+{{ mins }} min ⏱</span>
            {% endif %}
          </td>

          <td class="fw-bold" data-label="Estado">{{ ot.estado_publico }}</td>

          <td data-label="Acciones">
            <div class="d-flex flex-wrap gap-2 ot-actions">

              <form method="post" action="{% url 'operador_cambiar_estado' ot.ticket.id %}">
                {% csrf_token %}
                <input type="hidden" name="estado" value="LAB_PEDIDO">
                <button class="btn btn-sm btn-outline-dark">Lab pedido</button>
              </form>

              <form method="post" action="{% url 'operador_cambiar_estado' ot.ticket.id %}">
                {% csrf_token %}
                <input type="hidden" name="estado" value="BISELADO">
                <button class="btn btn-sm btn-outline-primary">Biselado</button>
              </form>

              <form method="post" action="{% url 'operador_cambiar_estado' ot.ticket.id %}">
                {% csrf_token %}
                <input type="hidden" name="estado" value="UV">
                <button class="btn btn-sm btn-outline-warning">UV</button>
              </form>

              <form method="post" action="{% url 'operador_cambiar_estado' ot.ticket.id %}">
                {% csrf_token %}
                <input type="hidden" name="estado" value="LISTO">
                <button class="btn btn-sm btn-success">Listo</button>
              </form>

              <form method="post" action="{% url 'operador_cambiar_estado' ot.ticket.id %}">
                {% csrf_token %}
                <input type="hidden" name="estado" value="ENTREGADO">
                <button class="btn btn-sm btn-danger">Entregado</button>
              </form>

            </div>

            <div class="mt-2 small text-muted">
              Últ. actualización: {{ ot.fecha_hora_ultima_actualizacion|date:"d/m H:i" }}
            </div>
          </td>
        </tr>
        {% endwith %}
        {% empty %}
        <tr>
          <td colspan="6" class="text-center">No hay órdenes activas.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="mt-3 small text-muted">
    Semáforo SLA:
    <span class="badge bg-success">A tiempo</span>
    <span class="badge bg-warning text-dark">1–10 min tarde</span>
    <span class="badge bg-danger">11+ min tarde</span>
  </div>

</div>
{% endblock %}

